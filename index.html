<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Legends of Love: Jesse's Quest ðŸ’˜</title>
  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    body { margin: 0; background: #000; color: #fff; font-family: 'Courier New', monospace; height: 100vh; overflow: hidden; touch-action: none; }
    
    #app-container { display: flex; flex-direction: column; width: 100vw; height: 100vh; background: #111; max-width: 600px; margin: auto; position: relative; }

    #screen-container { flex: 2.5; background: #000; display: flex; align-items: center; justify-content: center; padding: 10px; box-sizing: border-box; }
    #frame { width: 100%; height: 100%; border: 4px solid #669de6; border-radius: 8px; box-shadow: 0 0 20px rgba(102, 157, 230, 0.4); overflow: hidden; position: relative; }
    canvas { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }

    #controls-container { flex: 1.2; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: #1a1a1a; border-top: 2px solid #333; z-index: 10; }
    .dpad { position: relative; width: 140px; height: 140px; }
    .btn { background: #333; border: 2px solid #555; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #fff; position: absolute; width: 48px; height: 48px; box-shadow: 0 4px #000; }
    .btn.active { background: #ff4d4d !important; transform: translateY(2px); box-shadow: 0 1px #000; border-color: #fff; }

    #btn-down { bottom: 0; left: 47px; } #btn-left { left: 0; top: 47px; } #btn-right { right: 0; top: 47px; }

    .action-group { display: flex; gap: 15px; }
    .action-btn { width: 75px; height: 75px; border-radius: 50%; background: #333; border: 4px solid #555; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #fff; box-shadow: 0 5px #000; }
    #btn-a { border-color: #00ffff; } #btn-b { border-color: #ff4d4d; }
    #btn-a.active { background: #00ffff !important; color: #000; transform: scale(0.9); }
    #btn-b.active { background: #ff4d4d !important; color: #000; transform: scale(0.9); }

    .overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); z-index: 100; }
    .modal { background: #111; color: #fff; padding: 20px; border: 4px solid #ffd700; text-align: center; width: 85%; border-radius: 15px; max-height: 85vh; overflow-y: auto; }
    .modal img { max-width: 250px; max-height: 250px; width: auto; height: auto; border: 3px solid #fff; margin: 15px auto; display: block; border-radius: 10px; }
    .caption { font-size: 14px; line-height: 1.5; margin: 10px 0; color: #ccc; }
    
    button { padding: 15px 30px; background: #ff4d4d; color: #fff; border: 2px solid #fff; font-weight: bold; border-radius: 8px; cursor: pointer; text-transform: uppercase; }
    input { width: 90%; padding: 15px; margin: 15px 0; background: #000; color: #fff; border: 2px solid #ffd700; text-align: center; font-size: 20px; border-radius: 8px; }
  </style>
</head>
<body oncontextmenu="return false;">

<div id="app-container">
    <div id="screen-container">
        <div id="frame"><canvas id="game" width="800" height="450"></canvas></div>
    </div>
    <div id="controls-container">
        <div class="dpad">
            <div class="btn" id="btn-down">â–¼</div>
            <div class="btn" id="btn-left">â—€</div>
            <div class="btn" id="btn-right">â–¶</div>
        </div>
        <div class="action-group">
            <div class="action-btn" id="btn-b">ATK</div> 
            <div class="action-btn" id="btn-a">JMP</div> 
        </div>
    </div>

    <div class="overlay" id="modal-overlay">
        <div class="modal" id="modal-content">
            <h1 style="color:#ffd700">LEGENDS OF LOVE</h1>
            <p>Rescue Izzy & Stella, Jesse!</p>
            <button onclick="pressStart()">START QUEST</button>
        </div>
    </div>
</div>

<script>
const canvas = document.getElementById("game"), ctx = canvas.getContext("2d");
const W = 800, H = 450, GROUND_Y = 415;
let state = "TITLE", level = 0, heartsCollected = 0, introTimer = 0, gateOpen = false;
let storyTimer = 0, victoryTimer = 0;
const keys = { l:0, r:0, d:0, x:0, space:0 };
let projectiles = [];

// --- INPUTS ---
window.addEventListener('keydown', e => {
    const k = e.key.toLowerCase();
    if(k === "arrowleft") keys.l = 1; if(k === "arrowright") keys.r = 1;
    if(k === "arrowdown") keys.d = 1; if(k === " " || k === "arrowup") keys.space = 1;
    if(k === "z" || k === "x") keys.x = 1;
}, false);
window.addEventListener('keyup', e => {
    const k = e.key.toLowerCase();
    if(k === "arrowleft") keys.l = 0; if(k === "arrowright") keys.r = 0;
    if(k === "arrowdown") keys.d = 0; if(k === " " || k === "arrowup") keys.space = 0;
    if(k === "z" || k === "x") keys.x = 0;
}, false);

// --- AUDIO ---
const AudioCtx = new (window.AudioContext || window.webkitAudioContext)();
let musicLoop = null;
function playNote(freq, dur, vol = 0.05) {
    if(AudioCtx.state === 'suspended') AudioCtx.resume();
    const osc = AudioCtx.createOscillator(), gain = AudioCtx.createGain();
    osc.type = "square"; osc.frequency.setValueAtTime(freq, AudioCtx.currentTime);
    gain.gain.setValueAtTime(vol, AudioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.0001, AudioCtx.currentTime + dur);
    osc.connect(gain); gain.connect(AudioCtx.destination);
    osc.start(); osc.stop(AudioCtx.currentTime + dur);
}
function startMusic() {
    if(musicLoop) clearInterval(musicLoop);
    musicLoop = setInterval(() => { if(state === "PLAY") playNote([261, 329, 392, 523][Math.floor(Date.now()/200)%4], 0.2, 0.02); }, 200);
}

// --- ASSETS ---
const IMG = {};
function load(name, fn) { IMG[name] = new Image(); IMG[name].src = fn; IMG[name].onload = () => { IMG[name].ok = true; }; }
load('bg1','assets/bg1.png'); load('bg2','assets/bg2.png'); load('bg3','assets/bg3.png'); load('bg4','assets/bg4.png'); load('bg5','assets/bg5.png');
load('hero_idle','assets/hero_idle.png'); load('hero_atk','assets/hero_action.png');
load('partner','assets/partner.png'); load('dragon1','assets/dragon_1.png'); load('dragon2','assets/dragon_2.png'); 
load('slime','assets/slime.png'); load('crystal','assets/crystal.png'); load('tile','assets/tiles/tileset.png'); 
for(let i=1;i<=5;i++) load('p'+i, `assets/photos/photo${i}.jpg`);

function bindTouch(id, key) {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = 1; el.classList.add('active'); if(AudioCtx.state==='suspended')AudioCtx.resume(); }, {passive: false});
    el.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = 0; el.classList.remove('active'); }, {passive: false});
}
bindTouch('btn-left', 'l'); bindTouch('btn-right', 'r'); bindTouch('btn-down', 'd'); bindTouch('btn-b', 'x'); bindTouch('btn-a', 'space');

const chapters = [
    { name: "THE SEARCH", platforms: [{x:200, y:300, w:200}, {x:475, y:225, w:200}], quiz: "Who are you fighting for?", ans: ["izzy", "isabelle"], cap: "Every legend begins with knowing who you're fighting for." },
    { name: "THE PROMISE", platforms: [{x:100, y:325, w:150}, {x:400, y:200, w:150}], quiz: "Where did we get engaged?", ans: ["bull head", "bullhead"], cap: "Some places become legendary because of who stood there." },
    { name: "THE LEGACY", platforms: [{x:50, y:300, w:100}, {x:600, y:300, w:100}, {x:325, y:180, w:125}], quiz: "What is our daughter's name?", ans: ["stella"], cap: "From love, a universe was born." },
    { name: "THE CHOICE", platforms: [{x:50, y:350, w:75}, {x:200, y:275, w:75}, {x:400, y:200, w:75}], quiz: "Why do I choose you?", ans: ["anything"], cap: "Love was never trapped, it was waiting." },
    { name: "THE KINGDOM", platforms: [{x:50, y:275, w:200}, {x:550, y:275, w:200}], quiz: "Will you be my Valentine?", ans: ["yes", "i do"], cap: "" }
];

let hero = { x:50, y:250, w:100, h:150, vx:0, vy:0, hp:5, iframes:0, grounded:false, attacking:false, atkTimer:0, faceRight: true, crouching: false };
let boss = { x:600, y:250, w:150, h:140, hp:20, maxHP:20, alive:true, flash:0, fireTimer: 0 };
let gate = { x: W-125, y: GROUND_Y-150, w: 100, h: 100 };
let storyDragon = { x: 250, y: -200, w: 250, h: 200 }, storyPartner = { x: 250, y: GROUND_Y-112, w: 75, h: 112 }; 
let platforms = [], crystals = [];

function pressStart() {
    if(AudioCtx.state === 'suspended') AudioCtx.resume();
    document.getElementById('modal-overlay').style.display = 'none';
    state = "STORY"; storyTimer = 0;
}

function initLevel() {
    const c = chapters[level];
    hero.x = 50; hero.y = GROUND_Y - 150; hero.hp = 5;
    boss.alive = true; boss.hp = 20 + (level * 20); boss.maxHP = boss.hp; boss.x = 600; boss.fireTimer = 0;
    platforms = [{ x:0, y:GROUND_Y, w:W, h:50 }];
    c.platforms.forEach(p => platforms.push({x:p.x, y:p.y, w:p.w, h:25}));
    crystals = []; projectiles = []; heartsCollected = 0; gateOpen = false;
    c.platforms.forEach(p => crystals.push({ x: p.x + (p.w/2) - 25, y: p.y - 60, got: false }));
    state = "PLAY"; startMusic();
}

function update() {
    if(state === "STORY") {
        storyTimer++;
        if(storyTimer < 100) storyDragon.y += 5; else if(storyTimer < 150) { storyPartner.x = storyDragon.x+75; storyPartner.y = storyDragon.y+75; } else { storyDragon.y -= 4; storyPartner.x = storyDragon.x+75; storyPartner.y = storyDragon.y+75; }
        if(storyTimer > 350) { state = "INTRO"; introTimer = 120; } return;
    }
    if(state === "INTRO") { if(--introTimer <= 0) initLevel(); return; }
    
    // VICTORY REUNION LOGIC
    if(state === "VICTORY") {
        victoryTimer++; hero.y = GROUND_Y - hero.h; storyPartner.y = GROUND_Y - storyPartner.h;
        let targetJesse = W/2 - 40; let targetIzzy = W/2 - 20; // Slight overlap for a "hug"
        if(Math.abs(hero.x - targetJesse) > 4) hero.x += (hero.x < targetJesse) ? 4 : -4;
        if(Math.abs(storyPartner.x - targetIzzy) > 4) storyPartner.x += (storyPartner.x < targetIzzy) ? 4 : -4;
        if(victoryTimer > 350) winLevel(); return;
    }

    if(state !== "PLAY") return;

    if(keys.d) { if(!hero.crouching) { hero.crouching = true; hero.h = 75; hero.y += 75; } } else { if(hero.crouching) { hero.crouching = false; hero.y -= 75; hero.h = 150; } }
    let curSpd = hero.crouching ? 4 : 8;
    if(keys.l) { hero.vx = -curSpd; hero.faceRight = false; } else if(keys.r) { hero.vx = curSpd; hero.faceRight = true; } else hero.vx = 0;
    if(keys.space && hero.grounded && !hero.crouching) { hero.vy = -20; hero.grounded = false; playNote(400, 0.1); }
    
    hero.vy += 1.0; hero.x += hero.vx; hero.y += hero.vy;
    hero.grounded = false; platforms.forEach(p => {
        if (hero.x < p.x + p.w && hero.x + hero.w > p.x && hero.y < p.y + p.h && hero.y + hero.h > p.y) {
            if (hero.y + hero.h - hero.vy <= p.y) { hero.y = p.y - hero.h; hero.vy = 0; hero.grounded = true; }
        }
    });

    if(hero.x < 0) hero.x = 0; if(hero.x > W - hero.w) hero.x = W - hero.w;
    if(boss.alive) { 
        boss.x += (hero.x > boss.x) ? (3 + level) : -(3 + level); 
        boss.fireTimer++;
        if(boss.fireTimer > Math.max(35, 120 - level*25)) {
            projectiles.push({ x: boss.x, y: boss.y + 40, vx: -7 - level, w: 30, h: 30 });
            boss.fireTimer = 0; playNote(100, 0.05);
        }
    }

    projectiles.forEach((p, i) => { p.x += p.vx; if(rectIntersect(hero, p) && hero.iframes <= 0) { hero.hp--; hero.iframes = 60; playNote(50, 0.3); projectiles.splice(i, 1); } if(p.x < -50) projectiles.splice(i, 1); });
    if(keys.x && !hero.attacking) { hero.attacking = true; hero.atkTimer = 18; playNote(200, 0.1); }
    if(hero.attacking && --hero.atkTimer <= 0) hero.attacking = false;

    if(boss.alive && rectIntersect(hero, boss)) {
        if(hero.attacking) { boss.hp--; boss.flash = 8; playNote(200, 0.05); if(boss.hp <= 0) { boss.alive = false; if(level === 4) { state = "VICTORY"; victoryTimer = 0; storyPartner.x = 700; } } }
        else if(hero.iframes <= 0) { hero.hp--; hero.iframes = 60; playNote(80, 0.3); if(hero.hp <= 0) location.reload(); }
    }
    if(hero.iframes > 0) hero.iframes--;
    crystals.forEach(c => { if(!c.got && rectIntersect(hero, {x:c.x, y:c.y, w:50, h:50})) { c.got = true; heartsCollected++; playNote(800, 0.1); } });
    if(!boss.alive && heartsCollected >= crystals.length && level !== 4) { gateOpen = true; if(rectIntersect(hero, gate)) winLevel(); }
}

function drawHeart(x, y, size) {
    ctx.save(); ctx.translate(x, y); ctx.beginPath(); ctx.moveTo(0, size / 4);
    ctx.bezierCurveTo(0, size / 10, -size / 2, size / 10, -size / 2, size / 2.5);
    ctx.bezierCurveTo(-size / 2, size * 0.7, 0, size, 0, size * 1.2);
    ctx.bezierCurveTo(0, size, size / 2, size * 0.7, size / 2, size / 2.5);
    ctx.bezierCurveTo(size / 2, size / 10, 0, size / 10, 0, size / 4);
    ctx.fill(); ctx.restore();
}

function draw() {
    ctx.clearRect(0,0,W,H);
    let bg = IMG['bg'+(level+1)]; if(state==="STORY") bg = IMG.bg1; if(state==="VICTORY") bg = IMG.bg5;
    if(bg && bg.ok) ctx.drawImage(bg, 0, 0, W, H);

    if(state === "INTRO") {
        ctx.fillStyle="black"; ctx.fillRect(0,0,W,H); ctx.fillStyle="#ffd700"; ctx.textAlign="center"; ctx.font="bold 40px Courier";
        ctx.fillText(chapters[level].name, W/2, H/2); return;
    }

    if(state === "STORY") {
        if(IMG.hero_idle.ok) ctx.drawImage(IMG.hero_idle, hero.x, hero.y, hero.w, hero.h);
        if(IMG.partner.ok) ctx.drawImage(IMG.partner, storyPartner.x, storyPartner.y, storyPartner.w, storyPartner.h);
        if(IMG.dragon1.ok) ctx.drawImage(IMG.dragon1, storyDragon.x, storyDragon.y, storyDragon.w, storyDragon.h);
        if(storyTimer > 180) { ctx.fillStyle="white"; ctx.font="bold 28px Courier"; ctx.textAlign="center"; ctx.strokeStyle="black"; ctx.lineWidth=6; ctx.strokeText("NO! I WILL SAVE THEM!", W/2, 100); ctx.fillText("NO! I WILL SAVE THEM!", W/2, 100); }
        return;
    }

    platforms.forEach(p => { if(IMG.tile.ok) { for(let x=0; x<p.w; x+=32) ctx.drawImage(IMG.tile, 32, 0, 32, 32, p.x+x, p.y, 32, 32); } });
    crystals.forEach(c => { if(!c.got && IMG.crystal.ok) ctx.drawImage(IMG.crystal, c.x, c.y, 50, 50); });
    projectiles.forEach(p => { ctx.fillStyle = "#ffaa00"; ctx.beginPath(); ctx.arc(p.x+15, p.y+15, 15, 0, Math.PI*2); ctx.fill(); });

    if(boss.alive) {
        if(boss.flash > 0) { ctx.filter = "brightness(3)"; boss.flash--; }
        let d = level === 4 ? IMG.dragon1 : IMG.slime;
        if(d && d.ok) ctx.drawImage(d, boss.x, boss.y, boss.w, boss.h);
        ctx.filter = "none"; ctx.fillStyle="red"; ctx.fillRect(boss.x, boss.y-15, boss.w*(boss.hp/boss.maxHP), 8);
    }
    
    if(state === "VICTORY") {
        ctx.fillStyle="#ff0055"; 
        drawHeart(W/2, 100, 100 + Math.sin(Date.now()/150)*20); // Massive Pulsating Victory Heart
        if(IMG.hero_idle.ok) ctx.drawImage(IMG.hero_idle, hero.x, hero.y, hero.w, hero.h);
        if(IMG.partner.ok) ctx.drawImage(IMG.partner, storyPartner.x, storyPartner.y, storyPartner.w, storyPartner.h);
    } else if(gateOpen) { 
        ctx.fillStyle="#ff0055"; drawHeart(gate.x+50, gate.y+20, 70 + Math.sin(Date.now()/200)*10); 
    }

    if(state === "PLAY") {
        let s = hero.attacking ? IMG.hero_atk : IMG.hero_idle;
        if(hero.iframes % 10 < 5 && s && s.ok) {
            ctx.save(); if(!hero.faceRight){ ctx.translate(hero.x+hero.w, hero.y); ctx.scale(-1,1); ctx.drawImage(s,0,0,hero.w,hero.h); } else ctx.drawImage(s, hero.x, hero.y, hero.w, hero.h); ctx.restore();
        }
    }

    ctx.fillStyle="rgba(0,0,0,0.6)"; ctx.fillRect(0,0,W,45); ctx.fillStyle="#ff4d4d"; ctx.font="bold 24px Courier"; ctx.textAlign="left"; ctx.fillText("â™¥".repeat(hero.hp), 15, 30);
    ctx.fillStyle="#00ffff"; ctx.textAlign="right"; ctx.fillText("ðŸ’Ž"+heartsCollected, W-15, 30);
}

function rectIntersect(r1, r2) { return !(r2.x > r1.x + r1.w || r2.x + r2.w < r1.x || r2.y > r1.y + r1.h || r2.y + r2.h < r1.y); }

function winLevel() { 
    state="QUIZ"; document.getElementById('modal-overlay').style.display = 'flex';
    document.getElementById('modal-content').innerHTML = `
        <h2 style="color:#ffd700">LEVEL CLEAR</h2>
        <p>${chapters[level].quiz}</p>
        <input type="text" id="ans" placeholder="Tap to type..." autocomplete="off">
        <br><button onclick="checkAnswer()">UNLOCK</button>
    `;
    setTimeout(() => { let i = document.getElementById('ans'); if(i) { i.focus(); i.click(); } }, 200);
}

function checkAnswer() { 
    let v = document.getElementById('ans').value.toLowerCase().trim(); 
    // THE FIX: Level 4 (index 3) accepts anything.
    if(level === 3 || chapters[level].ans.includes(v)) showPhoto(); 
    else document.getElementById('ans').style.borderColor="red"; 
}

function showPhoto() { 
    let capText = chapters[level].cap;
    let isEnd = (level === 4), html = "";
    if(isEnd) html = `<h2>VICTORY!</h2><img src="assets/photos/photo5.jpg"><p class="caption">Jesseâ€¦ this is the part where the hero wins the kingdom.<br><br>But the truth is, you already did<br>You chose us.<br><br>I love you. Happy Valentineâ€™s Day ðŸ’–</p><button onclick="location.reload()">REPLAY</button>`;
    else html = `<h2>MEMORY UNLOCKED</h2><img src="assets/photos/photo${level+1}.jpg"><p class="caption">${capText}</p><button onclick="level++; state='INTRO'; introTimer=120; document.getElementById('modal-overlay').style.display='none';">NEXT LEVEL</button>`;
    document.getElementById('modal-content').innerHTML = html; 
}

function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();

document.getElementById('modal-content').innerHTML = `
    <h1 style="color:#ffd700">LEGENDS OF LOVE</h1>
    <p>Rescue Izzy & Stella, Jesse!</p>
    <button onclick="pressStart()">START QUEST</button>
`;
</script>
</body>
</html>
